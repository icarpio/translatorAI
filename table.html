<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Lista de Traducciones</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }
      th,
      td {
        padding: 12px;
        border: 1px solid #ddd;
        text-align: left;
      }
      th {
        background-color: #f4f4f4;
      }
      tr:hover {
        background-color: #f1f1f1;
      }
      #loading {
        font-size: 16px;
        color: #555;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Lista de Traducciones</h1>
      <div id="loading">Cargando traducciones...</div>
      <table
        id="traducciones-table"
        class="table table-striped"
        style="display: none"
      >
        <thead>
          <tr>
            <th>ID</th>
            <th>Espa√±ol</th>
            <th>Detalle</th>
            <th>Delete</th>
          </tr>
        </thead>
        <tbody id="traducciones-body">
          <!-- Filas se llenar√°n con JS -->
        </tbody>
      </table>
      <div
        class="d-flex justify-content-between align-items-center my-3"
        id="paginacion"
        style="display: none"
      >
        <button class="btn btn-outline-primary" onclick="paginaAnterior()">
          ‚¨ÖÔ∏è
        </button>
        <span id="pagina-actual" class="fw-bold"></span>
        <button class="btn btn-outline-primary" onclick="paginaSiguiente()">
          ‚û°Ô∏è
        </button>
      </div>

      <!-- üîô Bot√≥n volver al index -->
      <div class="mb-3">
        <a href="index.html" class="btn btn-secondary">‚¨ÖÔ∏è</a>
      </div>
    </div>

    <!-- Modal para detalle -->
    <div class="modal fade" id="detalleModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Detalle de Traducci√≥n</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <p>
              <strong>Espa√±ol:</strong> <span id="modal-espanol"></span>
              <button
                class="btn btn-sm btn-outline-secondary"
                onclick="leerTextoModal('modal-espanol','es-ES')"
              >
                üîä
              </button>
            </p>
            <p>
              <strong>Ingl√©s:</strong> <span id="modal-ingles"></span>
              <button
                class="btn btn-sm btn-outline-secondary"
                onclick="leerTextoModal('modal-ingles','en-GB')"
              >
                üîä
              </button>
            </p>
            <p>
              <strong>Italiano:</strong> <span id="modal-italiano"></span>
              <button
                class="btn btn-sm btn-outline-secondary"
                onclick="leerTextoModal('modal-italiano','it-IT')"
              >
                üîä
              </button>
            </p>
            <p>
              <strong>Fecha de Creaci√≥n:</strong> <span id="modal-fecha"></span>
            </p>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cerrar
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const API_URL = "https://albertaapi.onrender.com/api5/list/";
      const API_DELETE_URL = "https://albertaapi.onrender.com/api5/delete/";

      const tbody = document.getElementById("traducciones-body");
      const table = document.getElementById("traducciones-table");
      const loading = document.getElementById("loading");
      const paginacion = document.getElementById("paginacion");
      const paginaActualTexto = document.getElementById("pagina-actual");

      let traduccionesData = [];
      let urlActual = API_BASE_URL;

      async function cargarTraducciones(url = API_BASE_URL) {
        tbody.innerHTML = "";
        loading.style.display = "block";
        table.style.display = "none";
        paginacion.style.display = "none";

        try {
          const res = await fetch(url);
          const data = await res.json();
          traduccionesData = data.results || [];

          loading.style.display = "none";

          if (traduccionesData.length > 0) {
            table.style.display = "table";
            paginacion.style.display = "flex";
            urlActual = url;

            tbody.innerHTML = traduccionesData
              .map(
                (t) => `
                    <tr>
                        <td>${t.id}</td>
                        <td>${t.espa√±ol}</td>
                        <td><button class="btn btn-primary btn-sm" onclick="mostrarDetalle(${t.id})">üëÅÔ∏è</button></td>
                        <td><button class="btn btn-danger btn-sm" onclick="borrarTraduccion(${t.id})">üóëÔ∏è</button></td>
                    </tr>
                `
              )
              .join("");

            // Mostrar n√∫mero de p√°gina basado en par√°metros
            const params = new URL(url).searchParams;
            const pagina = params.get("page") || 1;
            paginaActualTexto.textContent = `P√°gina ${pagina}`;

            // Guardar las URLs next y previous
            window.urlSiguiente = data.next;
            window.urlAnterior = data.previous;
          } else {
            loading.textContent = "No hay traducciones guardadas.";
          }
        } catch (err) {
          console.error("Error cargando traducciones:", err);
          loading.textContent = "Error al cargar traducciones.";
        }
      }

      function paginaSiguiente() {
        if (window.urlSiguiente) {
          cargarTraducciones(window.urlSiguiente);
        }
      }

      function paginaAnterior() {
        if (window.urlAnterior) {
          cargarTraducciones(window.urlAnterior);
        }
      }

      function mostrarDetalle(id) {
        const t = traduccionesData.find((item) => item.id === id);
        if (!t) return alert("Traducci√≥n no encontrada");

        document.getElementById("modal-espanol").textContent = t.espa√±ol;
        document.getElementById("modal-ingles").textContent = t.ingles;
        document.getElementById("modal-italiano").textContent = t.italiano;
        document.getElementById("modal-fecha").textContent =
          t.fecha_creacion || "Sin fecha";

        const modal = new bootstrap.Modal(
          document.getElementById("detalleModal")
        );
        modal.show();
      }

      function leerTextoModal(idElemento, lang) {
        const texto = document.getElementById(idElemento).textContent.trim();
        if (!texto) return;
        const utterance = new SpeechSynthesisUtterance(texto);
        utterance.lang = lang;
        speechSynthesis.speak(utterance);
      }

      // Borrar traducci√≥n
      async function borrarTraduccion(id) {
        if (!confirm("¬øSeguro que quieres borrar esta traducci√≥n?")) return;

        try {
          const response = await fetch(API_DELETE_URL + id + "/", {
            method: "DELETE",
          });

          // Si la API responde 204 No Content, no intentes parsear JSON
          if (response.status === 204) {
            alert("Traducci√≥n eliminada correctamente");
            cargarTraducciones();
            return;
          }

          const data = await response.json();

          if (response.ok) {
            alert(data.mensaje || "Traducci√≥n eliminada");
            cargarTraducciones();
          } else {
            alert(data.error || "Error al borrar");
          }
        } catch (err) {
          console.error("Error:", err);
          alert("Error en la conexi√≥n al servidor");
        }
      }

      // Cargar lista al iniciar
      document.addEventListener("DOMContentLoaded", cargarTraducciones);
    </script>
  </body>
</html>
